name: Remind Approver On New Commit

on:
  pull_request:
    types: [synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  remind-approver:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Find dismissed approvers and notify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          dismissed_approvers=$(
            gh api "/repos/$REPO/pulls/$PR_NUMBER/reviews" \
            | jq -r '
                (map(select(.state == "DISMISSED") | .user.login) | unique) as $dismissed_users
                | (map(select(.state == "APPROVED") | .user.login) | unique) as $approved_users
                | ($dismissed_users | .[] | select(in($approved_users[])))
              ' | sort -u
          )

          if [ -z "$dismissed_approvers" ]; then
            echo "No dismissed approvers found."
            exit 0
          fi

          for reviewer in $dismissed_approvers; do
            echo "Notifying @$reviewer ..."
            gh pr comment "$PR_NUMBER" --repo "$REPO" \
              --body "@$reviewer New commits have been pushed. Your previous approval was dismissed. Please review again. $PR_URL"
          done
